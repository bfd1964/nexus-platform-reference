# Copyright (c) 2017-present Sonatype, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

events {
}

http {
  proxy_send_timeout        120;
  proxy_read_timeout        300;
  proxy_buffering           off;
  keepalive_timeout         5 5;
  tcp_nodelay               on;

  client_max_body_size      1G;

  server {
    listen                  443 ssl;
    server_name             nexus;

    ssl_certificate         /etc/nginx/external/cert.pem;
    ssl_certificate_key     /etc/nginx/external/key.pem;    

    location / {
      proxy_pass            http://nexus:8081/;
      proxy_redirect        off;
      proxy_set_header      Host $host;
      proxy_set_header      X-Real-IP $remote_addr;
      proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header      X-Forwarded-Host $server_name;
      proxy_set_header      X-Forwarded-Proto $scheme;
    }
  }

  server {
    listen                  443 ssl;
    server_name             repo.mycompany.com;

    ssl_certificate         /etc/nginx/external/cert.pem;
    ssl_certificate_key     /etc/nginx/external/key.pem;    

    location / {
      proxy_pass            http://nexus:8081/;
      proxy_redirect        off;
      proxy_set_header      Host $host;
      proxy_set_header      X-Real-IP $remote_addr;
      proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header      X-Forwarded-Host $server_name;
      proxy_set_header      X-Forwarded-Proto $scheme;
    }
  }

  server {
    listen                  443 ssl;
    listen                  8011;
    server_name             iq-server;

    ssl_certificate         /etc/nginx/external/cert.pem;
    ssl_certificate_key     /etc/nginx/external/key.pem;

    location / {
      proxy_pass            http://iq-server:8070/;
      proxy_redirect        off;
      proxy_set_header      Host $host;
      proxy_set_header      X-Real-IP $remote_addr;
      proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header      X-Forwarded-Host $server_name;
      proxy_set_header      X-Forwarded-Proto $scheme;
      
		set $cors 'true';
		if ($cors = 'true') {
				add_header 'Access-Control-Allow-Origin' "$http_origin" always;
				add_header 'Access-Control-Allow-Credentials' 'true' always;
				add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
				add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Requested-With' always;
				# required to be able to read Authorization header in frontend
				#add_header 'Access-Control-Expose-Headers' 'Authorization' always;
		}

		if ($request_method = 'OPTIONS') {
				# Tell client that this pre-flight info is valid for 20 days
				add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type' always;
				add_header 'Access-Control-Allow-Origin' "$http_origin" always;
				add_header 'Access-Control-Max-Age' 1728000;
				add_header 'Content-Type' 'text/plain charset=UTF-8';
				add_header 'Content-Length' 0;
				return 204;
		}


    }
  } 

  server {
    listen                  443 ssl;
    server_name             iq-server.mycompany.com;

    ssl_certificate         /etc/nginx/external/cert.pem;
    ssl_certificate_key     /etc/nginx/external/key.pem;    

    location / {
      proxy_pass            http://iq-server:8070/;
      proxy_redirect        off;
      proxy_set_header      Host $host;
      proxy_set_header      X-Real-IP $remote_addr;
      proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header      X-Forwarded-Host $server_name;
      proxy_set_header      X-Forwarded-Proto $scheme;
    }
  } 

  server {
    listen                  5000 ssl;
    server_name             nexus;

    ssl_certificate         /etc/nginx/external/cert.pem;
    ssl_certificate_key     /etc/nginx/external/key.pem;    

    location / {
      proxy_pass            http://nexus:5000/;
      proxy_redirect        off;
      proxy_set_header      Host $host;
      proxy_set_header      X-Real-IP $remote_addr;
      proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header      X-Forwarded-Host $server_name;
      proxy_set_header      X-Forwarded-Proto $scheme;
    }
  }

  server {
    listen                  5000 ssl;
    server_name             registry.mycompany.com;

    ssl_certificate         /etc/nginx/external/cert.pem;
    ssl_certificate_key     /etc/nginx/external/key.pem;

    location / {
      proxy_pass            http://nexus:5000/;
      proxy_redirect        off;
      proxy_set_header      Host $host;
      proxy_set_header      X-Real-IP $remote_addr;
      proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header      X-Forwarded-Host $server_name;
      proxy_set_header      X-Forwarded-Proto $scheme;
    }
  }

  server {
    listen                  18443 ssl;
    server_name             nexus;

    ssl_certificate         /etc/nginx/external/cert.pem;
    ssl_certificate_key     /etc/nginx/external/key.pem;    

    location / {
      proxy_pass            http://nexus:18443/;
      proxy_redirect        off;
      proxy_set_header      Host $host;
      proxy_set_header      X-Real-IP $remote_addr;
      proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header      X-Forwarded-Host $server_name;
      proxy_set_header      X-Forwarded-Proto $scheme;
    }
  }

server {
    listen                  443 ssl;
    server_name             registry.mycompany.com;

    ssl_certificate         /etc/nginx/external/cert.pem;
    ssl_certificate_key     /etc/nginx/external/key.pem;    

    location / {
      proxy_pass            http://nexus:18443/;
      proxy_redirect        off;
      proxy_set_header      Host $host;
      proxy_set_header      X-Real-IP $remote_addr;
      proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header      X-Forwarded-Host $server_name;
      proxy_set_header      X-Forwarded-Proto $scheme;
    }
  } 
}